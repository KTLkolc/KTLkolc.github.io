<!DOCTYPE html>
<html>
<head>
    <title>纸上谈兵 - GitHub Pages版</title>
    <script src="https://cdn.ably.io/lib/ably.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #gameMap { 
            width: 1600px; height: 1600px; 
            background: url('map-bg.jpg') center/cover;
            position: relative;
        }
        .player {
            width: 40px; height: 40px;
            border-radius: 50%;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 3px solid;
        }
    </style>
</head>
<body>
    <div id="gameMap"></div>
    
    <script>
        // 初始化Ably (替换为您的API密钥)
        const ably = new Ably.Realtime('Oisy4A.7B4RLg:GhQziK7Q4iDLdwpg8MDTIyql6csRSGse13FAhqxgJ8Y');
        const channel = ably.channels.get('paper-strategy-room');
        
        // 玩家状态
        const myPlayer = {
            id: 'player-' + Math.random().toString(36).substr(2, 9),
            name: localStorage.getItem('playerName') || 
                  prompt('请输入你的名字:', '玩家' + Math.floor(Math.random() * 1000)),
            x: 800,
            y: 800,
            color: getRandomColor()
        };
        
        // 保存玩家名称
        localStorage.setItem('playerName', myPlayer.name);
        
        // 创建自己的玩家
        createPlayer(myPlayer, true);
        
        // 订阅其他玩家移动
        channel.subscribe('player-move', updatePlayerPosition);
        
        // 订阅新玩家加入
        channel.subscribe('player-join', addPlayer);
        
        // 订阅玩家离开
        channel.subscribe('player-left', removePlayer);
        
        // 加入游戏
        channel.publish('player-join', myPlayer);
        
        // 键盘控制
        document.addEventListener('keydown', (e) => {
            const speed = 10;
            let dx = 0, dy = 0;
            
            switch(e.key) {
                case 'ArrowUp': case 'w': dy = -speed; break;
                case 'ArrowDown': case 's': dy = speed; break;
                case 'ArrowLeft': case 'a': dx = -speed; break;
                case 'ArrowRight': case 'd': dx = speed; break;
            }
            
            if (dx !== 0 || dy !== 0) {
                myPlayer.x = Math.max(0, Math.min(1600, myPlayer.x + dx));
                myPlayer.y = Math.max(0, Math.min(1600, myPlayer.y + dy));
                
                // 发布移动消息
                channel.publish('player-move', {
                    id: myPlayer.id,
                    x: myPlayer.x,
                    y: myPlayer.y
                });
                
                updateMyPosition();
            }
        });
        
        // 玩家元素创建
        function createPlayer(player, isMe = false) {
            const playerEl = document.createElement('div');
            playerEl.className = 'player';
            playerEl.id = player.id;
            playerEl.style.left = player.x + 'px';
            playerEl.style.top = player.y + 'px';
            playerEl.style.backgroundColor = player.color;
            playerEl.style.borderColor = isMe ? '#fff' : '#000';
            playerEl.textContent = player.name.charAt(0);
            playerEl.title = player.name;
            
            document.getElementById('gameMap').appendChild(playerEl);
            return playerEl;
        }
        
        function addPlayer(player) {
            if (player.id !== myPlayer.id && !document.getElementById(player.id)) {
                createPlayer(player);
            }
        }
        
        function updatePlayerPosition(data) {
            const playerEl = document.getElementById(data.id);
            if (playerEl) {
                playerEl.style.left = data.x + 'px';
                playerEl.style.top = data.y + 'px';
            }
        }
        
        function updateMyPosition() {
            const playerEl = document.getElementById(myPlayer.id);
            if (playerEl) {
                playerEl.style.left = myPlayer.x + 'px';
                playerEl.style.top = myPlayer.y + 'px';
            }
        }
        
        function removePlayer(data) {
            const playerEl = document.getElementById(data.id);
            if (playerEl) {
                playerEl.remove();
            }
        }
        
        function getRandomColor() {
            return `hsl(${Math.random() * 360}, 70%, 60%)`;
        }
        
        // 离开时通知其他玩家
        window.addEventListener('beforeunload', () => {
            channel.publish('player-left', { id: myPlayer.id });
        });
    </script>
</body>
</html>
